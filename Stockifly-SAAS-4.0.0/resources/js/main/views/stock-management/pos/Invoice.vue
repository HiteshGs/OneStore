<template>
  <a-modal
    :open="visible"
    :centered="true"
    :maskClosable="false"
    :title="$t('common.print_invoice')"
    width="900px"
    @cancel="onClose"
  >
    <div id="pos-invoice">
      <div
        id="pos-invoice-inner"
        :class="['invoice-root', sizeClass]"
        v-if="order && order.xid"
        style="margin: 0 auto"
      >
        <!-- TOP HEADER (STORE INFO) -->
        <div class="invoice-header">
          <div class="invoice-meta-center">
            <h2 class="tax-invoice-title">
              {{ $t('sales.tax_invoice') }}
            </h2>
          </div>
          <div class="invoice-header-text">
            <h1 class="store-name">
              {{ selectedWarehouse.name }}
            </h1>
            <p class="store-address">
              {{ selectedWarehouse.address }}
            </p>

            <!-- GSTIN -->
            <p class="store-gstin-line">
              <strong>GSTIN: {{ displayGSTIN }}</strong>
            </p>
          </div>

          <!-- TOP RIGHT CONTACT INFO -->
          <div class="invoice-header-contact">
            <p class="store-contact-line">
              <span v-if="selectedWarehouse.phone && selectedWarehouse.show_phone_on_invoice">
                Phone: {{ selectedWarehouse.phone }}
              </span>
              <span v-if="selectedWarehouse.email && selectedWarehouse.show_email_on_invoice && selectedWarehouse.phone && selectedWarehouse.show_phone_on_invoice">
                &nbsp;&nbsp;|&nbsp;&nbsp;Email: {{ selectedWarehouse.email }}
              </span>
              <span v-else-if="selectedWarehouse.email && selectedWarehouse.show_email_on_invoice">
                Email: {{ selectedWarehouse.email }}
              </span>
            </p>
          </div>
          <img
            class="invoice-logo"
            :src="selectedWarehouse.logo_url"
            :alt="selectedWarehouse.name"
          />
        </div>

        <!-- BILL TO + INVOICE DETAILS -->
        <div class="bill-party-row">
          <!-- LEFT: Customer Details -->
          <div class="bill-party-left">
            <h4 class="bill-title">Bill To Party</h4>
            <p class="party-line party-name">
              {{ order.user?.name || posSelectedCustomer?.name || 'Walk-in Customer' }}
            </p>
            <p
              v-if="order.user?.phone || posSelectedCustomer?.phone"
              class="party-line"
            >
              Mo: {{ order.user?.phone || posSelectedCustomer?.phone }}
            </p>

            <br />

            <!-- GSTIN (Customer) -->
            <p v-if="order.user?.gst_number" class="party-line">
              <strong>GSTIN:</strong> {{ order.user.gst_number }}
            </p>

            <p
              v-if="finalCustomerAddress"
              class="party-line address-line"
            >
              {{ finalCustomerAddress }}
            </p>
            <p v-else class="party-line text-muted">
              <em>Address not available</em>
            </p>
          </div>

          <!-- RIGHT: Invoice Details -->
          <div class="bill-party-right">
            <table class="invoice-details-table-print-safe">
              <tbody>
                <tr>
                  <td class="meta-label">Invoice No</td>
                  <td class="meta-value">{{ order.invoice_number }}</td>
                </tr>
                <tr>
                  <td class="meta-label">Date</td>
                  <td class="meta-value">{{ formatDate(order.order_date) }}</td>
                </tr>
                <tr>
                  <td class="meta-label">Generated by</td>
                  <td class="meta-value">{{ displayName || 'Admin' }}</td>
                </tr>
                <tr>
                  <td class="meta-label">Generated at</td>
                  <td class="meta-value">{{ currentTime }}</td>
                </tr>
                <tr
                  v-if="selectedWarehouse.city || selectedWarehouse.state"
                >
                  <td class="meta-label">Location</td>
                  <td class="meta-value">
                    {{
                      [selectedWarehouse.city, selectedWarehouse.state]
                        .filter(Boolean)
                        .join(', ')
                    }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ITEMS TABLE -->
        <div class="tax-invoice-items">
          <table class="items-table">
            <thead>
              <tr>
                <th style="width: 5%">NO</th>
                <th style="width: 35%">{{ $t('common.item') }}</th>
                <th style="width: 8%">{{ $t('common.qty') }}</th>
                <th style="width: 12%">{{ $t('common.rate') }}</th>
                <th style="width: 8%">{{ $t('product.tax') }} %</th>
                <th style="width: 12%; text-align: right">
                  {{ $t('common.total') }}
                </th>
              </tr>
            </thead>
            <tbody>
              <!-- FIXED ROW TABLE USING paddedItems -->
              <tr
                :class="['item-row', item.__blank ? 'blank-row' : '']"
                v-for="(item, index) in paddedItems"
                :key="item.xid || index"
              >
                <!-- Sr No -->
                <td class="center">
                  {{ item.__blank ? '' : index + 1 }}
                </td>

                <!-- Item name + custom fields -->
                <td>
                  <div class="item-name">
                    {{ item.__blank ? '' : item.product?.name }}
                  </div>

                  <div
                    v-if="!item.__blank && item.custom_fields && item.custom_fields.length"
                    class="item-custom-fields"
                  >
                    <span
                      v-for="cf in item.custom_fields"
                      :key="cf.id || cf.name || cf.label"
                      class="item-custom-field-line"
                    >
                      {{ cf.label || cf.name }}: {{ cf.value }}
                    </span>
                  </div>
                </td>


                <!-- QTY -->
                <td class="center">
                  {{ item.__blank ? '' : item.quantity }}
                </td>

                <!-- RATE -->
                <td class="right">
                  {{
                    item.__blank
                      ? ''
                      : formatAmountCurrency(item.unit_price)
                  }}
                </td>

                <!-- GST % -->
                <td class="center">
                  {{ item.__blank ? '' : (getTaxRate(item) || '-') }}
                </td>

                <!-- TOTAL (WITH TAX) -->
                <td class="right">
                  {{
                    item.__blank
                      ? ''
                      : formatAmountCurrency(item.subtotal)
                  }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- FINAL TOTALS BOX -->
        <div class="final-totals-box">
          <table class="items-table">
            <tbody>
              <!-- ROW 1: GROSS / SGST / CGST -->
              <tr>
                <td class="label-strong">GROSS AMT :</td>
                <td class="value-right">
                  {{ formatAmountCurrency(getGrossAmount(order)) }}
                </td>
                <td class="label-strong">SGST :</td>
                <td class="value-right">
                  {{ formatAmountCurrency(computedSGST) }}
                </td>
                <td class="label-strong">CGST :</td>
                <td class="value-right">
                  {{ formatAmountCurrency(computedCGST) }}
                </td>
              </tr>

              <!-- ROW 2: IGST / NET AMOUNT -->
              <tr>
                <td class="label-strong">IGST :</td>
                <td class="value-right">
                  {{ formatAmountCurrency(computedIGST) }}
                </td>
                <td class="label-strong net-amount-label" style="text-align: left;">
                  NET AMOUNT :
                </td>
                <td
                  class="value-right net-amount-value"
                  colspan="3"
                  style="text-align: left;"
                >
                  {{ formatAmountCurrency(order.total) }}
                </td>
              </tr>

              <!-- ROW 3: PAID / DUE -->
              <tr>
                <td class="label-strong">PAID AMOUNT :</td>
                <td class="value-right paid-strong">
                  {{ formatAmountCurrency(paidAmount) }}
                  <span
                    v-if="paidAmount > 0 && order.order_payments?.length"
                    class="payment-modes-inline"
                  >
                    ({{ order.order_payments
                        .map(p => p.payment?.payment_mode?.name || 'Cash')
                        .filter(Boolean)
                        .join(' + ')
                    }})
                  </span>
                </td>

                <td class="label-strong">DUE AMOUNT :</td>
                <td
                  class="value-right due-strong"
                  colspan="3"
                >
                  {{ formatAmountCurrency(dueAmount) }}
                </td>
              </tr>

              <!-- RUPEES IN WORDS -->
              <tr v-if="order.amount_in_words">
                <td
                  colspan="6"
                  style="
                    padding: 8px 10px;
                    font-style: italic;
                    color: #555;
                    font-size: 12px;
                  "
                >
                  <strong>Rupees in Words:</strong>
                  {{ order.amount_in_words }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- BOTTOM SECTION – BANK DETAILS + TERMS + SIGNATURE -->
        <div class="bottom-section">
          <!-- BANK DETAILS STRIP -->
          <div class="bank-details-box">
            <strong class="bank-title">BANK DETAIL :</strong>
            <div class="bank-items">
              <span>A/c No : {{ bankDetailsToShow.accountNo }}</span>
              <span class="separator">|</span>
              <span>Bank : {{ bankDetailsToShow.bank }}</span>
              <span class="separator">|</span>
              <span>Branch : {{ bankDetailsToShow.branch }}</span>
              <span class="separator">|</span>
              <span>IFSC : {{ bankDetailsToShow.ifsc }}</span>
            </div>
          </div>

          <!-- TERMS + SIGNATURE BOXES -->
          <div class="bottom-boxes-row">
            <div class="terms-box-final">
              <div class="terms-header">Terms Of Sales :</div>
              <div class="terms-content">
                {{
                  selectedWarehouse.invoice_terms ||
                  'Goods once sold will be taken back or exchanged within 10 Days.'
                }}
              </div>
              <div class="for-company">
                For :
                {{ selectedWarehouse.name || 'SHAYONA HANDLOOM & HANDICRAFT' }}
              </div>
            </div>

            <div class="signature-box-final">
              <div class="signature-title">Authorised Signatory</div>
              <div class="signature-space"></div>
              <div class="company-name-bottom">
                {{ selectedWarehouse.name || 'SHAYONA HANDLOOM & HANDICRAFT' }}
              </div>
            </div>
          </div>
        </div>

        <!-- BARCODE / QR + THANK YOU -->
        <!-- <div
          v-if="selectedWarehouse.barcode_type == 'barcode'"
          class="barcode-details"
        >
          <BarcodeGenerator
            :value="order.invoice_number + ''"
            :height="25"
            :width="1"
            :fontSize="15"
            :elementTag="'svg'"
          />
        </div> -->
        <!-- <div
          v-else
          style="text-align: center"
          class="qrcode-details"
        >
          <QRcodeGenerator :text="order.invoice_number + ''" />
        </div> -->

        <div class="thanks-details">
          <p class="thanks-text">
            Thank You For Shopping With Us. Please Come Again
          </p>
        </div>
      </div>
    </div>

    <template #footer>
      <div class="footer-button">
        <a-button
          v-if="order?.user?.email && isVerified"
          type="primary"
          @click="sendInvoiceMail(order.xid, selectedLang)"
          :loading="isSending"
        >
          <template #icon><SendOutlined /></template>
          {{ $t('common.send_invoice') }}
        </a-button>

        <a-button
          type="default"
          @click="downloadPdf"
          style="margin-right: 8px"
        >
          <template #icon><DownloadOutlined /></template>
          Download PDF
        </a-button>

        <a-button
          type="primary"
          @click="printInvoice"
        >
          <template #icon><PrinterOutlined /></template>
          {{ $t('common.print_invoice') }}
        </a-button>
      </div>
    </template>
  </a-modal>
</template>

<script>
import {
  ref,
  defineComponent,
  onMounted,
  computed,
  watch,
  nextTick,
} from 'vue';
import {
  PrinterOutlined,
  SendOutlined,
  DownloadOutlined,
} from '@ant-design/icons-vue';
import common from '../../../../common/composable/common';
import BarcodeGenerator from '../../../../common/components/barcode/BarcodeGenerator.vue';
import QRcodeGenerator from '../../../../common/components/barcode/QRcodeGenerator.vue';
import { notification } from 'ant-design-vue';
import { useI18n } from 'vue-i18n';
// import html2pdf from 'html2pdf.js';

const posInvoiceCssUrl = window.config.pos_invoice_css;

// Static fallbacks
const FALLBACK_GSTIN = '24BNGPG0699R1ZD';
const FALLBACK_BANK = {
  accountNo: '18650200016691',
  bank: 'THE FEDERAL BANK',
  branch: 'SURAT VARACHHA',
  ifsc: 'FDRL0001865',
};
const authUser = JSON.parse(localStorage.getItem('auth_user')) || {};
const displayName = authUser.name || {};
const currentTime = new Date().toLocaleString();

export default defineComponent({
  props: {
    visible: { type: Boolean, default: false },
    order: { type: Object, default: null },
    size: { type: String, default: 'A4' },
    autoOpen: { type: Boolean, default: false },
  },
  emits: ['closed', 'success'],
  components: {
    PrinterOutlined,
    SendOutlined,
    DownloadOutlined,
    BarcodeGenerator,
    QRcodeGenerator,
  },
  setup(props, { emit }) {
    const { t } = useI18n();
    const {
      formatAmountCurrency,
      formatDate,
      selectedWarehouse,
      selectedLang,
    } = common();

    const isSending = ref(false);
    const isVerified = ref('');

    onMounted(() => {
      axiosAdmin.get('verified-email').then(response => {
        isVerified.value = response.data?.verified;
      });
    });

    // Debug
    watch(
      () => props.order,
      o => {
        if (o) {
          console.log('POS Invoice Order:', JSON.parse(JSON.stringify(o)));
          if (Array.isArray(o.items)) {
            console.log(
              'POS Invoice Order Items:',
              JSON.parse(JSON.stringify(o.items)),
            );
          }
        }
      },
      { immediate: true },
    );

    const downloadPdf = async () => {
      await nextTick();

      const element = document.getElementById('pos-invoice-inner');
      if (!element) {
        notification.error({
          message: 'Error',
          description: 'Invoice element not found',
        });
        return;
      }

      // Fix SVG elements for PDF
      const svgs = element.querySelectorAll('svg');
      svgs.forEach(svg => {
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '60');
      });

      let format = 'a4';
      let margin = [8, 8, 8, 8];

      if (props.size === 'A5') format = 'a5';
      else if (props.size === '80MM') {
        format = [80, 'auto'];
        margin = [3, 3, 3, 3];
      } else if (props.size === '58MM') {
        format = [58, 'auto'];
        margin = [2, 2, 2, 2];
      }

      const opt = {
        margin,
        filename: `${props.order?.invoice_number || 'POS'}.pdf`,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: {
          scale: 4,
          useCORS: true,
          letterRendering: true,
          backgroundColor: '#ffffff',
          logging: false,
          allowTaint: false,
          scrollX: 0,
          scrollY: 0,
          windowWidth: document.documentElement.offsetWidth,
          windowHeight: document.documentElement.offsetHeight,
        },
        jsPDF: {
          unit: 'mm',
          format,
          orientation: 'portrait',
          compress: false,
          precision: 16
        }
      };

      try {
        // await html2pdf().set(opt).from(element).save();
        console.log('PDF generation disabled - html2pdf.js not installed');
        notification.success({
          message: 'Success',
          description: 'Invoice PDF downloaded!',
        });
      } catch (error) {
        console.error('PDF generation error:', error);
        notification.error({
          message: 'Error',
          description: 'Failed to download PDF: ' + (error.message || 'Unknown error'),
        });
      }
    };

    const onClose = () => emit('closed');

    const posSelectedCustomer = computed(() => {
      try {
        const raw = localStorage.getItem('pos_selected_customer');
        return raw ? JSON.parse(raw) : null;
      } catch (e) {
        return null;
      }
    });

    const finalCustomerAddress = computed(() => {
      return (
        (props.order?.user?.address ||
          posSelectedCustomer.value?.address ||
          ''
        ).trim()
      );
    });

    const customerState = computed(() => {
      const addr = finalCustomerAddress.value.toLowerCase();
      const gujaratKeywords = [
        'gujarat',
        'gujrat',
        'gj',
        'surat',
        'ahmedabad',
        'vadodara',
        'rajkot',
        'bhavnagar',
        'jamnagar',
        'anand',
        'gandhinagar',
        'bharuch',
        'valsad',
        'navsari',
      ];
      return gujaratKeywords.some(kw => addr.includes(kw))
        ? 'Gujarat'
        : 'Other State';
    });

    const isIntraState = computed(() => customerState.value === 'Gujarat');

    const totalTaxAmount = computed(() => {
      if (!props.order?.items || !Array.isArray(props.order.items)) return 0;

      return props.order.items.reduce((sum, item) => {
        return sum + Number(item.total_tax || 0);
      }, 0);
    });

    const computedSGST = computed(() =>
      isIntraState.value ? totalTaxAmount.value / 2 : 0,
    );
    const computedCGST = computed(() =>
      isIntraState.value ? totalTaxAmount.value / 2 : 0,
    );
    const computedIGST = computed(() =>
      isIntraState.value ? 0 : totalTaxAmount.value,
    );

    watch(
      () => props.order,
      newOrder => {
        if (!newOrder || !newOrder.xid) return;

        const tax = Number(newOrder.tax_amount) || 0;
        const detectedState = customerState.value;
        const isGujarat = detectedState === 'Gujarat';

        console.log('════════════════════════════════');
        console.log('GST SPLIT DEBUG (Invoice: %s)', newOrder.invoice_number);
        console.log('Customer Address →', newOrder.user?.address || 'N/A');
        console.log('Customer City    →', newOrder.user?.city || 'N/A');
        console.log('Detected State   →', detectedState);
        console.log('Is Gujarat?      →', isGujarat ? 'YES' : 'NO');
        console.log('Total Tax Amount →', tax.toFixed(2));
        console.log('→ SGST           →', computedSGST.value.toFixed(2));
        console.log('→ CGST           →', computedCGST.value.toFixed(2));
        console.log('→ IGST           →', computedIGST.value.toFixed(2));
        console.log(
          'Check Sum        →',
          (
            computedSGST.value +
            computedCGST.value +
            computedIGST.value
          ).toFixed(2),
          '==',
          tax.toFixed(2),
        );
        console.log('════════════════════════════════\n');
      },
      { immediate: true },
    );

    const sendInvoiceMail = async (xid, lang) => {
      isSending.value = true;
      try {
        await axiosAdmin.get(`send-mail/${xid}/${lang}`);
        notification.success({
          message: t('common.success'),
          description: t('common.mail_sent_successfully'),
          duration: 4.5,
        });
      } catch (error) {
        notification.error({
          message: t('common.error'),
          description: t('common.failed_to_send_mail'),
          duration: 4.5,
        });
      } finally {
        isSending.value = false;
      }
    };

    const sizeClass = computed(() => {
      const s = (props.size || 'A4').toUpperCase();
      if (s === 'A5') return 'a5-invoice';
      if (s === '80MM') return 'thermal-80';
      if (s === '58MM') return 'thermal-58';
      return 'a4-invoice';
    });

    const printInvoice = async () => {
      await nextTick();

      const element = document.getElementById('pos-invoice-inner');
      if (!element) {
        notification.error({
          message: 'Error',
          description: 'Invoice element not found',
        });
        return;
      }

      // Fix SVG elements for printing
      const svgs = element.querySelectorAll('svg');
      svgs.forEach(svg => {
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '60');
      });

      // Get all styles from the document
      const allStyles = Array.from(document.styleSheets)
        .map(styleSheet => {
          try {
            return Array.from(styleSheet.cssRules).map(rule => rule.cssText).join('\n');
          } catch (e) {
            return '';
          }
        }).join('\n');

      // Get inline styles from the component
      const inlineStyles = Array.from(document.querySelectorAll('style'))
        .map(style => style.textContent)
        .join('\n');

      // Create a hidden iframe for printing
      const iframe = document.createElement('iframe');
      iframe.style.position = 'absolute';
      iframe.style.left = '-9999px';
      iframe.style.top = '-9999px';
      iframe.style.width = '0px';
      iframe.style.height = '0px';
      document.body.appendChild(iframe);

      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

      // Write the complete invoice document
      iframeDoc.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Invoice ${props.order?.invoice_number || ''}</title>
          <style>
            ${allStyles}
            ${inlineStyles}
            @media print {
              @page {
                margin: 0.5cm;
                size: A4;
              }
              body {
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background: #fff !important;
              }
              * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
              }
            }
            @media screen {
              body {
                margin: 20px;
                background: #fff;
              }
            }
          </style>
        </head>
        <body>
          ${element.outerHTML}
        </body>
        </html>
      `);

      iframeDoc.close();

      // Wait for content to load, then print
      iframe.onload = () => {
        setTimeout(() => {
          iframe.contentWindow.print();
          // Remove iframe after printing
          setTimeout(() => {
            document.body.removeChild(iframe);
          }, 1000);
        }, 500);
      };
    };

    const getTaxableAmount = item => {
      const taxable = item.subtotal - item.total_tax;
      return taxable > 0 ? taxable : 0;
    };

    const getTaxRate = item => {
      if (item.tax_rate !== null && item.tax_rate !== undefined && item.tax_rate !== '') {
        return Number(item.tax_rate);
      }
      const subtotal = Number(item.subtotal) || 0;
      const tax = Number(item.tax_amount) || Number(item.total_tax) || 0;
      const taxable = subtotal - tax;
      if (taxable > 0 && tax > 0) {
        return Number(((tax / taxable) * 100).toFixed(2));
      }
      return 0;
    };

    const getGrossAmount = order => {
      if (!order?.items || !Array.isArray(order.items)) return 0;

      return order.items.reduce((sum, item) => {
        return sum + Number(item.subtotal || 0);
      }, 0);
    };

    const gstSummary = computed(() => {
      if (!props.order?.items || !Array.isArray(props.order.items)) return [];

      const summary = {};
      props.order.items.forEach(item => {
        const rate = getTaxRate(item);
        if (rate) {
          if (!summary[rate]) {
            summary[rate] = {
              rate,
              taxable: 0,
              tax: 0,
            };
          }
          summary[rate].taxable += getTaxableAmount(item);
          summary[rate].tax += Number(item.total_tax || 0);
        }
      });

      return Object.values(summary);
    });

    const gstSummaryTotals = computed(() => {
      const totalTaxable = gstSummary.value.reduce(
        (sum, item) => sum + item.taxable,
        0,
      );
      const totalTax = gstSummary.value.reduce(
        (sum, item) => sum + item.tax,
        0,
      );
      return { totalTaxable, totalTax };
    });

    const displayGSTIN = computed(() => {
      return selectedWarehouse.value.gst_number || FALLBACK_GSTIN;
    });

    const bankDetailsToShow = computed(() => {
      return {
        accountNo: selectedWarehouse.value.bank_account_no || FALLBACK_BANK.accountNo,
        bank: selectedWarehouse.value.bank_name || FALLBACK_BANK.bank,
        branch: selectedWarehouse.value.bank_branch || FALLBACK_BANK.branch,
        ifsc: selectedWarehouse.value.ifsc_code || FALLBACK_BANK.ifsc,
      };
    });

    const paddedItems = computed(() => {
      const items = Array.isArray(props.order?.items)
        ? props.order.items
        : [];
      const MIN_ROWS = 20; // Fixed 20 rows for A4 format
      const blanksToAdd = Math.max(0, MIN_ROWS - items.length);

      const blankRows = Array.from(
        { length: blanksToAdd },
        (_, i) => ({
          __blank: true,
          xid: `blank-${i}`,
        }),
      );

      return [...items, ...blankRows];
    });

    const paidAmount = computed(() => {
      return props.order?.order_payments?.reduce(
        (sum, p) => sum + Number(p.amount || 0),
        0,
      ) || 0;
    });

    const dueAmount = computed(() => {
      return (props.order?.total || 0) - paidAmount.value;
    });

    return {
      onClose,
      formatDate,
      displayName,
      currentTime,
      selectedWarehouse,
      formatAmountCurrency,
      printInvoice,
      downloadPdf,
      selectedLang,
      sendInvoiceMail,
      isSending,
      isVerified,
      sizeClass,
      getTaxableAmount,
      getTaxRate,
      getGrossAmount,
      gstSummary,
      gstSummaryTotals,
      displayGSTIN,
      bankDetailsToShow,
      customerState,
      computedSGST,
      computedCGST,
      computedIGST,
      posSelectedCustomer,
      finalCustomerAddress,
      paddedItems,
      paidAmount,
      dueAmount,
    };
  },
});
</script>

<style>
.invoice-header {
  text-align: center;
  border-bottom: 1px solid #000 !important;
  padding-bottom: 10px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 8px;
}
.invoice-logo {
  width: 3%;
  position: absolute;
  left: 0;
  top: 0px;
}
.invoice-header-text {
  text-align: center;
  margin-top: 0;
  width: 100%;
}
.tax-invoice-title {
  margin: 0 0 1px 0;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  text-decoration: none;
  letter-spacing: 1px;
}
.store-name {
  margin: 0 0 2px 0;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
}
.store-address {
  margin: 4px 0;
  font-size: 10px;
}
.store-contact-line {
  margin: 4px 0;
  font-size: 10px;
  font-weight: 500;
  color: #333;
}
.store-gstin-line {
  margin: 4px 0 0 0;
  font-size: 11px;
  font-weight: 700;
  color: #000;
  letter-spacing: 0.5px;
  text-align: center;
}

.store-gstin-line strong {
  font-weight: 900;
  color: #000;
}

/* Top right contact info */
.invoice-header-contact {
  position: absolute;
  right: 0;
  top: 0;
  text-align: right;
}
.invoice-header-contact .store-contact-line {
  margin: 0;
  font-size: 10px;
  font-weight: 500;
  color: #333;
}

/* Bill to party row */
.bill-party-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin: 20px 0 6px;
  padding-bottom: 6px;
  /*border-bottom: 1px solid #000;*/
  page-break-inside: avoid;
}

.bill-party-left {
  flex: 1;
  min-width: 50%;
}
.address-line {
  font-weight: 500;
  margin-top: 2px;
  white-space: pre-line;
}

.bill-party-right {
  width: 40%;
  margin-right: 8px;
}

/* Invoice Details Table */
.invoice-details-table-print-safe {
  border-collapse: collapse;
  font-size: 10px;
  background: #ffffff;
  border: 1px solid #000;
  min-width: 280px;
  float: right;
  margin: 0; /* Removed extra margin */
}
.invoice-details-table-print-safe th,
.invoice-details-table-print-safe td {
  padding: 7px;
  border: 1px solid #000;
  background: #ffffff;
}
.invoice-details-table-print-safe .meta-label {
  font-weight: 600;
  color: #000 !important;
  width: 100px;
  text-align: left;
  background: #ffffff !important;
}
.invoice-details-table-print-safe .meta-value {
  font-weight: 500;
  color: #000 !important;
  text-align: left;
  padding-left: 5px !important;
  background: #ffffff !important;
}

.meta-label {
  font-weight: 700;
  color: #333;
  text-align: left;
  width: 100px;
  white-space: nowrap;
}
.meta-value {
  font-weight: 600;
  color: #000;
  text-align: left;
  padding-left: 8px;
}

.bill-title {
  margin: 0 0 2px 0;
  font-size: 11px;
  font-weight: bold;
  color: #000;
  border-bottom: 1px solid #000;
  display: inline-block;
  padding-bottom: 1px;
}

.party-line {
  margin: 2px 0;
  font-size: 10px;
}
.party-name {
  font-weight: 600;
}

/* Items table */
.tax-invoice-items {
  margin-top: 8px;
}
.items-table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid #000;
}
.items-table th,
.items-table td {
  border: 1px solid #000;
  border-width: 1px;
  padding: 6px; /* reduced padding so more rows fit */
  font-size: 10px;
  font-weight: 500;
  vertical-align: middle;
  height: 30px; /* reduced from 25px */
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}
.items-table thead {
  background: #ffffff; /* Set to white for print consistency */
  font-weight: 700;
  text-transform: uppercase;
}
.items-table th {
  text-align: center;
  font-weight: 700;
  font-size: 10px;
  padding: 7px;
  border: 1px solid #000;
  background: #ffffff; /* Set to white for print consistency */
}
.item-name {
  font-weight: 500;
  font-size: 10px;
  line-height: 1.2;
}
.item-custom-fields {
  margin-top: 1px;
}
.item-custom-field-line {
  display: block;
  font-size: 9px;
  line-height: 1.1;
}

.item-row td {
  height: 30px; /* reduced from 30px */
  vertical-align: middle;
}
.item-row.blank-row td {
  height: 30px; /* reduced from 30px */
  border: 0.5px solid #000;
  vertical-align: middle;
}

.center {
  text-align: center;
}
.right {
  text-align: right;
}

/* FINAL TOTALS BOX */
.final-totals-box {
  margin: 4px 0 4px 0;
  border: 0px solid #000;
  background: #fff;
}
.final-totals-box .items-table {
  width: 100%;
  border-collapse: collapse !important;
  border: 0px solid #000 !important;
}
.final-totals-box .items-table td {
  border: 0px solid #000 !important;
  border-width: 1px !important;
  padding: 5px;
  font-size: 10px;
  font-weight: 600;
  vertical-align: middle;
  height: 18px;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
}
.final-totals-box .label-strong {
  font-weight: 400;
  color: #000;
  font-size: 10px;
  padding: 5px;
}
.final-totals-box .value-right {
  text-align: right;
  font-weight: 400;
  color: #000;
  font-size: 10px;
  padding: 5px;
}
.final-totals-box .paid-strong {
  color: green;
  font-weight: 400;
  font-size: 10px;
}
.final-totals-box .due-strong {
  color: red;
  font-weight: 400;
  font-size: 10px;
}

/* NET AMOUNT in same grid style */
.net-amount-label,
.net-amount-value {
  font-weight: 600 !important;
  font-size: 10px !important;
  color: #000 !important;
  background: #ffffff !important;
  padding: 5px !important;
  border: 0.5px solid #000 !important;
  border-collapse: collapse !important;
}

/* Bottom section: Bank + Terms + Sign */
.bottom-section {
  margin-top: 4px;
  font-size: 13px;
  page-break-inside: avoid;
}

/* BANK DETAILS STRIP */
.bank-details-box {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 0px;
  border: 1px solid #000;
  border-width: 1px;
  padding: 4px 8px;
  background: #fff;
  margin: 4px 0 4px;
  font-size: 10px;
  font-weight: 500;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
  flex-wrap: wrap;
}
.bank-title {
  font-weight: 900 !important;
  font-size: 10px;
  color: #000;
  min-width: 80px;
  text-align: left;
  margin-right: 10px;
}
.bank-items {
  display: flex;
  align-items: center;
  gap: 5px;
  flex-wrap: wrap;
  justify-content: flex-start;
  flex: 1;
}
.bank-items span {
  white-space: nowrap;
  font-weight: 500;
}
.separator {
  font-weight: bold;
  color: #000;
  font-size: 10px;
  margin: 0 3px;
}

/* TERMS + SIGN BOXES */
.bottom-boxes-row {
  display: flex;
  gap: 8px;
  margin-top: 4px;
}
.terms-box-final,
.signature-box-final {
  flex: 1;
  border: 1px solid #000;
  padding: 6px;
  height: 75px;
  position: relative;
  background: white;
  font-size: 10px;
}
.terms-header {
  font-weight: bold;
  font-size: 10px;
  margin-bottom: 2px;
  text-align: left;
}
.terms-content {
  line-height: 1.2;
  margin-bottom: 10px;
  font-size: 9px;
}
.for-company {
  position: absolute;
  bottom: 10px;
  left: 10px;
  font-weight: bold;
  font-size: 9px;
}
.signature-box-final {
  text-align: center;
}
.signature-title {
  font-weight: bold;
  font-size: 10px;
  margin-bottom: 2px;
}
.signature-space {
  height: 30px;
  border-bottom: 1px solid #000;
  margin: 4px 10px;
}
.company-name-bottom {
  margin-top: -2px;
  font-weight: bold;
  font-size: 9px;
}

/* THANK YOU */
.thanks-details {
  margin-top: 4px;
  text-align: center;
  border-top: 1px solid #ddd;
  padding-top: 4px;
}
.thanks-text {
  margin: 0;
  font-size: 10px;
  font-weight: 600;
  font-style: italic;
  color: #555;
}

/* BARCODE */
.barcode-details {
  margin-top: 2px;
  margin-bottom: 2px;
  text-align: center;
  font-size: 10px;
}

/* FOOTER BUTTONS */
.footer-button {
  text-align: right;
  margin-top: 6px;
}
.footer-button button {
  padding: 4px 10px;
  font-size: 10px;
}

/* size previews */
.invoice-root {
  width: 100%;
}
.a4-invoice {
  max-width: 210mm;
}
.a5-invoice {
  max-width: 148mm;
}
.thermal-80 {
  max-width: 80mm;
}
.thermal-58 {
  max-width: 58mm;
}
.thermal-80,
.thermal-58 {
  font-size: 12px;
}

/* PRINT */
@media print {
  @page {
    margin: 0.5cm;
    size: A4;
  }

  body {
    margin: 0;
    padding: 0;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    background: #fff !important;
  }

  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  .invoice-header,
  .bill-party-row,
  .tax-invoice-items,
  .final-totals-box,
  .bottom-section,
  .bank-details-box,
  .bottom-boxes-row {
    page-break-inside: avoid;
  }

  .invoice-header {
    border-bottom: 1px solid #000 !important;
  }

  /*.bill-party-row {
    border-bottom: 1px solid #000 !important;
  }*/

  .items-table,
  .items-table th,
  .items-table td {
    border: 1px solid #000 !important;
    border-width: 1px !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  .items-table th {
    border-bottom: 1px solid #000 !important;
    background: #ffffff !important;
  }

  .final-totals-box {
    border: 0px solid #000 !important;
  }

  .final-totals-box .items-table {
    border-collapse: collapse !important;
    border: 0px solid #000 !important;
  }

  .final-totals-box .items-table td {
    border: 0px solid #000 !important;
    border-width: 0.5px !important;
  }

  .net-amount-label {
  text-align: left !important;
}

.net-amount-value {
  text-align: right !important;
}

  .bank-details-box {
    border: 1px solid #000 !important;
  }

  .terms-box-final,
  .signature-box-final {
    border: 1px solid #000 !important;
  }

  .signature-space {
    border-bottom: 1px solid #000 !important;
  }

  .thanks-details {
    border-top: 1px solid #ddd !important;
  }

  .bill-party-right,
  .invoice-details-table-print-safe {
    float: right !important;
    color: #000 !important;
    background: #ffffff !important;
  }

  .invoice-details-table-print-safe {
    border-collapse: collapse !important;
    border: 1px solid #000 !important;
  }

  .invoice-details-table-print-safe td {
    border: 1px solid #000 !important;
    color: #000 !important;
    background: #ffffff !important;
  }

  .bottom-boxes-row {
    display: flex !important;
  }

  /* Ensure all text is black and borders are visible */
  .store-name,
  .store-address,
  .store-contact-line,
  .store-gstin-line,
  .party-line,
  .item-name,
  .label-strong,
  .value-right,
  .bank-title,
  .bank-items,
  .terms-header,
  .terms-content,
  .for-company,
  .signature-title,
  .company-name-bottom,
  .thanks-text {
    color: #000 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* Ensure backgrounds are white */
  .items-table thead,
  .final-totals-box .label-strong,
  .final-totals-box .value-right,
  .invoice-details-table-print-safe .meta-label,
  .invoice-details-table-print-safe .meta-value {
    background: #ffffff !important;
    color: #000 !important;
  }

  /* Top right contact info */
  .invoice-header-contact {
    position: absolute !important;
    right: 0 !important;
    top: 0 !important;
    text-align: right !important;
  }
}
</style>